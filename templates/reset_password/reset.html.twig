{% extends 'base.html.twig' %}

{% block title %}{{ 'reset_password.page_title'|trans }}{% endblock %}

{% block body %}
<div class="password-reset-container" style="max-width: 500px; margin: 50px auto; padding: 20px;">
    <h1 style="margin-bottom: 30px;">{{ 'reset_password.title'|trans }}</h1>

    {% for message in app.flashes('reset_password_error') %}
        <div style="padding: 15px; margin-bottom: 20px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;">
            ❌ {{ message }}
        </div>
    {% endfor %}

    {{ form_start(resetForm) }}
        <div class="form-group">
            {{ form_label(resetForm.plainPassword.first) }}
            {{ form_widget(resetForm.plainPassword.first, {'attr': {'id': 'password-field', 'class': 'form-control'}}) }}
            
            <!-- Password Strength Indicator -->
            <div style="margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div id="strength-bar" style="height: 100%; width: 0%; transition: all 0.3s ease; background: #ccc;"></div>
                    </div>
                    <span id="strength-text" style="font-size: 12px; font-weight: bold; min-width: 80px;"></span>
                </div>
            </div>
            
            <!-- Password Requirements -->
            <div style="margin-top: 15px; padding: 12px; background: #f5f5f5; border-radius: 4px; font-size: 13px;">
                <div style="font-weight: bold; margin-bottom: 8px; color: #333;">{{ 'reset_password.requirements'|trans }} :</div>
                <ul style="margin: 0; padding-left: 20px; list-style: none;">
                    <li id="req-length" style="margin-bottom: 4px;">
                        <span class="req-icon">○</span> {{ 'reset_password.min_12_chars'|trans }}
                    </li>
                    <li id="req-uppercase" style="margin-bottom: 4px;">
                        <span class="req-icon">○</span> {{ 'reset_password.one_uppercase'|trans }}
                    </li>
                    <li id="req-lowercase" style="margin-bottom: 4px;">
                        <span class="req-icon">○</span> {{ 'reset_password.one_lowercase'|trans }}
                    </li>
                    <li id="req-number" style="margin-bottom: 4px;">
                        <span class="req-icon">○</span> {{ 'reset_password.one_number'|trans }}
                    </li>
                    <li id="req-special" style="margin-bottom: 4px;">
                        <span class="req-icon">○</span> {{ 'reset_password.one_special'|trans }}
                    </li>
                </ul>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px; color: #d32f2f;">
                    <strong>⚠️ {{ 'reset_password.no_compromised'|trans }}</strong>
                </div>
            </div>
            
            {{ form_errors(resetForm.plainPassword.first) }}
        </div>

        <div class="form-group" style="margin-top: 20px;">
            {{ form_label(resetForm.plainPassword.second) }}
            {{ form_widget(resetForm.plainPassword.second, {'attr': {'class': 'form-control'}}) }}
            {{ form_errors(resetForm.plainPassword.second) }}
        </div>

        <button class="btn btn-primary" style="margin-top: 20px; width: 100%;">{{ 'reset_password.submit'|trans }}</button>
    {{ form_end(resetForm) }}
</div>

<style>
    .req-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        text-align: center;
        margin-right: 8px;
    }
    .requirement-met {
        color: #4CAF50 !important;
    }
    .requirement-met .req-icon {
        color: #4CAF50;
    }
    .requirement-met .req-icon::before {
        content: '✓';
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find the first password input field (Symfony generates its own IDs)
        const passwordField = document.querySelector('input[type="password"]');
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        
        // Requirement elements
        const reqLength = document.getElementById('req-length');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqLowercase = document.getElementById('req-lowercase');
        const reqNumber = document.getElementById('req-number');
        const reqSpecial = document.getElementById('req-special');
        
        if (!passwordField) {
            console.error('Password field not found');
            return;
        }
        
        passwordField.addEventListener('input', function() {
            const password = this.value;
            
            // Check requirements
            const hasLength = password.length >= 12;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[^A-Za-z0-9]/.test(password);
            
            // Update requirement indicators
            updateRequirement(reqLength, hasLength);
            updateRequirement(reqUppercase, hasUppercase);
            updateRequirement(reqLowercase, hasLowercase);
            updateRequirement(reqNumber, hasNumber);
            updateRequirement(reqSpecial, hasSpecial);
            
            // Calculate strength
            let strength = 0;
            if (hasLength) strength += 20;
            if (hasUppercase) strength += 20;
            if (hasLowercase) strength += 20;
            if (hasNumber) strength += 20;
            if (hasSpecial) strength += 20;
            
            // Bonus points for extra length
            if (password.length >= 16) strength += 10;
            if (password.length >= 20) strength += 10;
            
            strength = Math.min(strength, 100);
            
            // Update strength bar
            strengthBar.style.width = strength + '%';
            
            // Update color and text based on strength
            if (strength === 0) {
                strengthBar.style.background = '#ccc';
                strengthText.textContent = '';
            } else if (strength < 40) {
                strengthBar.style.background = '#F44336';
                strengthText.textContent = '{{ 'reset_password.weak'|trans }}';
                strengthText.style.color = '#F44336';
            } else if (strength < 60) {
                strengthBar.style.background = '#FF9800';
                strengthText.textContent = '{{ 'reset_password.fair'|trans }}';
                strengthText.style.color = '#FF9800';
            } else if (strength < 80) {
                strengthBar.style.background = '#2196F3';
                strengthText.textContent = '{{ 'reset_password.good'|trans }}';
                strengthText.style.color = '#2196F3';
            } else {
                strengthBar.style.background = '#4CAF50';
                strengthText.textContent = '{{ 'reset_password.strong'|trans }}';
                strengthText.style.color = '#4CAF50';
            }
        });
        
        function updateRequirement(element, met) {
            if (met) {
                element.classList.add('requirement-met');
            } else {
                element.classList.remove('requirement-met');
            }
        }
    });
</script>
{% endblock %}
