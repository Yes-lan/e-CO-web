{% extends 'base.html.twig' %}

{% block title %}{{ 'parcours.create_page_title'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('assets/css/style.css') }}">
{% endblock %}

{% block body %}
    <div class="course-creation-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <a href="{{ path('app_parcours_list') }}" class="back-link">‚Üê Retour √† la liste</a>
            <a href="{{ path('app_parcours_list') }}" class="btn btn-info btn-small">üóÇÔ∏è G√©rer les parcours</a>
        </div>

        <div class="creation-header">
            <h1>üìç Cr√©er un Nouveau Parcours</h1>
            <p>Configurez votre parcours d'orientation √©tape par √©tape</p>
        </div>

        <form id="courseCreationForm">
            <!-- Informations g√©n√©rales -->
            <div class="form-section">
                <h2>üìã Informations G√©n√©rales</h2>
                
                <div class="form-group">
                    <label for="courseName">Nom du parcours *</label>
                    <input type="text" id="courseName" name="courseName" required 
                           placeholder="Ex: Parcours For√™t de Montmorency">
                </div>

                <div class="form-group">
                    <label for="courseDescription">Description</label>
                    <textarea id="courseDescription" name="courseDescription" 
                              placeholder="D√©crivez votre parcours d'orientation..."></textarea>
                </div>
            </div>

            <!-- Point de d√©part/arriv√©e -->
            <div class="form-section">
                <h2>üö© Point de D√©part/Arriv√©e</h2>
                
                <div class="info-box">
                    <p>‚ÑπÔ∏è Le point de d√©part sera √©galement le point d'arriv√©e du parcours.</p>
                </div>

                <div class="form-group">
                    <label for="startPointName">Nom du point de d√©part *</label>
                    <input type="text" id="startPointName" name="startPointName" required 
                           placeholder="Ex: Parking de la for√™t">
                </div>

                <div class="form-group">
                    <label for="startPointDescription">Description du point de d√©part</label>
                    <textarea id="startPointDescription" name="startPointDescription" 
                              placeholder="Ex: Parking principal √† l'entr√©e sud de la for√™t"></textarea>
                </div>

                <div class="form-group">
                    <label>Position GPS</label>
                    <p style="color: #666; font-size: 0.9rem;">
                        üì± Les coordonn√©es GPS seront enregistr√©es lors du scan du QR code par l'enseignant sur le terrain.
                    </p>
                </div>
            </div>

            <!-- Nombre de balises -->
            <div class="form-section">
                <h2>üéØ Configuration des Balises</h2>
                
                <div class="form-group">
                    <label for="waypointCount">Nombre de balises (hors d√©part/arriv√©e)</label>
                    <div class="waypoint-count-selector">
                        <input type="number" id="waypointCount" name="waypointCount" 
                               min="1" max="20" value="5">
                        <button type="button" class="btn btn-secondary btn-small" id="generateWaypoints">
                            G√©n√©rer les balises
                        </button>
                    </div>
                </div>

                <div id="waypointsContainer" class="waypoints-container">
                    <!-- Waypoints will be generated here -->
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-success">
                    ‚úÖ Cr√©er le parcours
                </button>
            </div>
        </form>
    </div>

    {% block javascripts %}
        {{ parent() }}
        
        <script>
            (function() {
                // Course creation form initialization
                // Notification helper function
                function showNotification(message, type = 'success') {
                    // Remove any existing notifications
                    const existingNotif = document.querySelector('.notification');
                    if (existingNotif) {
                        existingNotif.remove();
                    }

                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.textContent = message;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                }

                function initializeCourseForm() {
                    const form = document.getElementById('courseCreationForm');
                    const generateBtn = document.getElementById('generateWaypoints');
                    const waypointCountInput = document.getElementById('waypointCount');
                    const waypointsContainer = document.getElementById('waypointsContainer');

                    if (!form || !generateBtn || !waypointCountInput || !waypointsContainer) {
                        return;
                    }

                    // Check if event listeners are already attached
                    const hasListeners = generateBtn.hasAttribute('data-listeners-attached');

                    if (hasListeners) {
                        return;
                    }

                    // Generate waypoint forms
                    const clickHandler = function(e) {
                        e.preventDefault();
                        
                        const count = parseInt(waypointCountInput.value);
                        waypointsContainer.innerHTML = '';

                        for (let i = 1; i <= count; i++) {
                            const waypointHtml = `
                                <div class="waypoint-item" data-waypoint-id="${i}">
                                    <div class="waypoint-header">
                                        <h4>Balise ${i}</h4>
                                        <div class="waypoint-controls">
                                            <button type="button" class="btn btn-danger btn-small remove-waypoint" data-waypoint="${i}">
                                                üóëÔ∏è Supprimer
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="waypoint_${i}_name">Nom de la balise</label>
                                        <input type="text" id="waypoint_${i}_name" name="waypoint_${i}_name" 
                                               placeholder="Ex: Balise ${i}" value="Balise ${i}">
                                    </div>
                                    <p style="color: #666; font-size: 0.9rem; margin: 0;">
                                        üì± Position GPS √† d√©finir sur le terrain via scan QR code
                                    </p>
                                </div>
                            `;
                            waypointsContainer.insertAdjacentHTML('beforeend', waypointHtml);
                        }

                        // Add remove handlers
                        document.querySelectorAll('.remove-waypoint').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const waypointId = this.getAttribute('data-waypoint');
                                const waypointItem = this.closest('.waypoint-item');
                                waypointItem.remove();
                                showNotification(`Balise ${waypointId} supprim√©e`, 'info');
                            });
                        });

                        showNotification(`${count} balises g√©n√©r√©es!`, 'success');
                    };

                    generateBtn.addEventListener('click', clickHandler);

                    // Mark button as having listeners attached
                    generateBtn.setAttribute('data-listeners-attached', 'true');

                    // Form submission
                    form.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const formData = {
                        name: document.getElementById('courseName').value,
                        description: document.getElementById('courseDescription').value,
                        startPoint: {
                            name: document.getElementById('startPointName').value,
                            description: document.getElementById('startPointDescription').value,
                            lat: null,
                            lng: null
                        },
                        waypoints: [],
                        status: 'draft',
                        createdAt: new Date().toISOString()
                    };

                    // Collect waypoint data
                    document.querySelectorAll('.waypoint-item').forEach((item, index) => {
                        const id = item.getAttribute('data-waypoint-id');
                        const waypoint = {
                            id: parseInt(id),
                            name: document.getElementById(`waypoint_${id}_name`)?.value || `Balise ${id}`,
                            latitude: null,
                            longitude: null,
                            type: 'control',
                            qr: ''
                        };

                        formData.waypoints.push(waypoint);
                    });

                    console.log('Course data to save:', formData);
                    
                    try {
                        // Save to backend API
                        const response = await AuthManager.fetch('{{ path('api_parcours_save', {'_locale': app.request.locale}) }}', {
                            method: 'POST',
                            body: JSON.stringify(formData)
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            showNotification(`Parcours "${formData.name}" cr√©√© avec succ√®s!`, 'success');
                            
                            // Redirect to parcours list after notification
                            setTimeout(() => {
                                window.location.href = '{{ path('app_parcours_list') }}';
                            }, 1500);
                        } else {
                            throw new Error(result.message || 'Erreur lors de la sauvegarde');
                        }
                    } catch (error) {
                        console.error('Error saving course:', error);
                        showNotification('Erreur lors de la cr√©ation du parcours', 'error');
                    }
                    });
                }

                // Track initialization per Turbo render
            let initialized = false;

            // Clean up on page unload
            document.addEventListener('turbo:before-render', function() {
                initialized = false;
            });

            // Initialize on Turbo load
            document.addEventListener('turbo:load', function() {
                if (!initialized) {
                    initialized = true;
                    initializeCourseForm();
                }
            });

            // Also initialize on DOMContentLoaded (fallback if Turbo doesn't fire)
            document.addEventListener('DOMContentLoaded', function() {
                if (!initialized) {
                    initialized = true;
                    initializeCourseForm();
                }
            });
            
            // Also initialize immediately if DOM is ready (first page load without Turbo)
            if (document.readyState !== 'loading' && !initialized) {
                initialized = true;
                initializeCourseForm();
            }
            })();
        </script>
    {% endblock %}
{% endblock %}
