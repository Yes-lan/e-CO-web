{% extends 'base.html.twig' %}

{% block title %}{{ 'parcours.page_title'|trans }}{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('assets/css/style.css') }}">
{% endblock %}

{% block body %}
<div class="parcours-page">
    <div class="parcours-header">
        <h1>{{ 'parcours.title'|trans }}</h1>
        <div class="parcours-header-actions">
            <div class="search-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="11" cy="11" r="8" stroke="#666" stroke-width="2"/>
                    <path d="M21 21l-4.35-4.35" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input type="text" id="searchInput">
            </div>
            <button class="btn btn-primary" id="newParcoursBtn" onclick="window.location.href='{{ path('app_parcours_create') }}'"
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2"/>
                    <path d="M12 8v8M8 12h8" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span id="newParcoursBtnText"></span>
            </button>
        </div>
    </div>

    <div class="course-grid" id="courseList">
        <p id="loadingMessage" style="text-align: center; color: #666; grid-column: 1 / -1;"></p>
    </div>
</div>

<!-- Edit Course Modal -->
<div id="editCourseModal" class="modal">
    <div class="modal-content modal-large">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2 id="modalTitle">{{ 'parcours.edit_modal_title'|trans }}</h2>

        <div id="editCourseContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>

<!-- QR Codes Modal -->
<div id="qrCodesModal" class="modal">
    <div class="modal-content modal-large">
        <span class="close" onclick="closeQRModal()">&times;</span>
        <h2>üî≤ {{ 'parcours.qr_codes_title'|trans }}</h2>
        
        <!-- Important information about QR code stability -->
        <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
            <p style="margin: 0; color: #0c5460; font-weight: 600;">
                ‚ÑπÔ∏è <strong>{{ 'parcours.qr_important'|trans }}</strong> {{ 'parcours.qr_permanent'|trans }}
            </p>
            <p style="margin: 0.5rem 0 0 0; color: #0c5460; font-size: 0.9rem;">
                {{ 'parcours.qr_print_info'|trans }}
            </p>
        </div>
        
        <div style="text-align: right; margin-bottom: 1rem;">
            <button class="btn btn-primary" id="downloadAllQRBtn" onclick="downloadAllQRCodes()"></button>
        </div>
        <div id="qrCodesContent" class="qr-codes-grid">
            <!-- QR codes loaded dynamically -->
        </div>
    </div>
</div>

{% block javascripts %}
    {{ parent() }}
    
    <script>
        // Use window object to prevent redeclaration errors with Turbo
        if (!window.manageCoursePageInitialized) {
            window.manageCoursePageInitialized = true;
            window.manageCourses = [];
            window.currentEditingCourse = null;
            window.qrCodeLibraryLoaded = false;
            window.jspdfLibraryLoaded = false;
        }

        // Initialize translated UI elements
        function initializeTranslatedElements() {
            const searchInput = document.getElementById('searchInput');
            const newParcoursBtnText = document.getElementById('newParcoursBtnText');
            const loadingMessage = document.getElementById('loadingMessage');
            const downloadAllQRBtn = document.getElementById('downloadAllQRBtn');
            
            if (searchInput) {
                searchInput.placeholder = trans('parcours.search_placeholder');
            }
            if (newParcoursBtnText) {
                newParcoursBtnText.textContent = trans('parcours.new_parcours');
            }
            if (loadingMessage) {
                loadingMessage.textContent = trans('parcours.loading');
            }
            if (downloadAllQRBtn) {
                downloadAllQRBtn.innerHTML = 'üì• ' + trans('parcours.download_all_qr');
            }
        }

        // Load Google Maps dynamically (same pattern as create.html.twig)
        window.loadGoogleMapsForManage = function() {
            if (window.google && window.google.maps) {
                console.log('Google Maps already loaded for manage page');
                return Promise.resolve();
            }

            if (document.querySelector('script[src*="maps.googleapis.com"]')) {
                console.log('Google Maps script already in document');
                return new Promise((resolve) => {
                    const checkGoogleMaps = setInterval(() => {
                        if (window.google && window.google.maps) {
                            clearInterval(checkGoogleMaps);
                            resolve();
                        }
                    }, 100);
                });
            }

            console.log('Loading Google Maps API for manage page...');
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBi8sXKGGafzB837kvxraWuqohlZ-JJRu8&libraries=geometry,places';
                script.async = true;
                script.defer = true;
                script.onload = function() {
                    console.log('Google Maps script loaded for manage page');
                    resolve();
                };
                script.onerror = function() {
                    console.error('Failed to load Google Maps script');
                    reject(new Error('Failed to load Google Maps'));
                };
                document.head.appendChild(script);
            });
        }



        // Load courses immediately
        async function initManagePage() {
            initializeTranslatedElements();
            await loadCourses();
        }

        document.addEventListener('DOMContentLoaded', initManagePage);
        document.addEventListener('turbo:load', initManagePage);

        async function loadCourses() {
            try {
                const response = await AuthManager.fetch('{{ path('api_parcours_list') }}');
                const data = await response.json();
                window.manageCourses = data.courses || [];
                console.log('COURSES PAGE: Loaded', window.manageCourses.length, 'courses:', window.manageCourses);
                displayCourses();
            } catch (error) {
                console.error('Error loading parcours:', error);
                document.getElementById('courseList').innerHTML = `<p style="color: #d32f2f; text-align: center;">${trans('parcours.error_loading')}</p>`;
            }
        }

        function displayCourses() {
            const container = document.getElementById('courseList');
            
            if (window.manageCourses.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #666;">${trans('parcours.no_parcours')} <a href="{{ path('app_parcours_create') }}">${trans('parcours.create_parcours')}</a></p>`;
                return;
            }

            container.innerHTML = window.manageCourses.map((course, index) => {
                const waypointCount = course.waypoints ? course.waypoints.length : 0;
                
                let statusText, statusColor;
                if (course.status === 'finished') {
                    statusText = trans('parcours.status.completed');
                    statusColor = '#4caf50';
                } else {
                    statusText = trans('parcours.status.in_creation');
                    statusColor = '#ff6b35';
                }
                
                return `
                    <div class="parcours-card">
                        <div class="parcours-card-header">
                            <div class="parcours-icon">S</div>
                            <div class="parcours-title">
                                <h3>${course.name || 'La Bastide'}</h3>
                                <span class="status-text" style="color: ${statusColor};">${statusText}</span>
                            </div>
                        </div>
                        
                        <p class="parcours-description">${course.description || trans('parcours.description.default')}</p>
                        
                        <div class="parcours-meta">
                            <span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z" stroke="#1976d2" stroke-width="2" fill="none"/>
                                </svg>
                                ${waypointCount} ${trans('parcours.info.beacons_count')}
                            </span>
                            <span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="#1976d2" stroke-width="2" fill="none"/>
                                    <line x1="3" y1="10" x2="21" y2="10" stroke="#1976d2" stroke-width="2"/>
                                    <line x1="8" y1="2" x2="8" y2="6" stroke="#1976d2" stroke-width="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6" stroke="#1976d2" stroke-width="2"/>
                                </svg>
                                ${new Date(course.createdAt).toLocaleDateString('fr-FR')}
                            </span>
                        </div>
                        
                        <div class="parcours-actions">
                            <button class="action-btn btn-qr" onclick="viewQRCodes(${index})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="3" width="7" height="7" stroke="white" stroke-width="2" fill="none"/>
                                    <rect x="14" y="3" width="7" height="7" stroke="white" stroke-width="2" fill="none"/>
                                    <rect x="3" y="14" width="7" height="7" stroke="white" stroke-width="2" fill="none"/>
                                    <rect x="14" y="14" width="7" height="7" stroke="white" stroke-width="2" fill="none"/>
                                </svg>
                                ${trans('parcours.qr_codes')}
                            </button>
                            ${course.status !== 'finished' ? `
                            <button class="action-btn btn-view" onclick="viewCourse(${index})" style="background: #2196f3;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z" stroke="white" stroke-width="2"/>
                                    <circle cx="12" cy="12" r="3" stroke="white" stroke-width="2"/>
                                </svg>
                                ${trans('parcours.view')}
                            </button>
                            <button class="action-btn btn-edit" onclick="editCourse(${index})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                ${trans('parcours.edit')}
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteCourse(${index})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="white" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                            ` : `
                            <button class="action-btn btn-view" onclick="viewCourse(${index})" style="background: #2196f3;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z" stroke="white" stroke-width="2"/>
                                    <circle cx="12" cy="12" r="3" stroke="white" stroke-width="2"/>
                                </svg>
                                ${trans('parcours.view')}
                            </button>
                            <span style="padding: 0.5rem 1rem; background: #4caf50; color: white; border-radius: 4px; font-weight: 500;">
                                ‚úì ${trans('parcours.finished')}
                            </span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewCourse(index) {
            const course = window.manageCourses[index];
            // Redirect to map page with only courseId (no session)
            window.location.href = `/map?courseId=${course.id}`;
        }

        function editCourse(index) {
            const courseData = window.manageCourses[index];
            const course = { ...courseData, index };

            // Convert waypoint coordinates from strings to numbers
            if (course.waypoints) {
                course.waypoints = course.waypoints.map(wp => ({
                    ...wp,
                    latitude: parseFloat(wp.latitude),
                    longitude: parseFloat(wp.longitude),
                    lat: parseFloat(wp.lat || wp.latitude),
                    lng: parseFloat(wp.lng || wp.longitude)
                }));
            }

            window.currentEditingCourse = course;
            showEditModal();
        }

        function showEditModal() {
            const modal = document.getElementById('editCourseModal');
            const content = document.getElementById('editCourseContent');

            const course = window.currentEditingCourse;
            const isFinished = course.status === 'finished';

            if (isFinished) {
                // Read-only view for finished courses
                content.innerHTML = `
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                        <strong>‚ö†Ô∏è Parcours termin√©</strong> - Ce parcours est termin√© et ne peut plus √™tre modifi√©.
                    </div>

                    <!-- Basic Info -->
                    <div class="edit-section">
                        <h3>‚ÑπÔ∏è Informations G√©n√©rales</h3>
                        <div class="form-group">
                            <label>Nom du parcours:</label>
                            <input type="text" value="${course.name || ''}" disabled style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <textarea disabled style="background: #f5f5f5; cursor: not-allowed;">${course.description || ''}</textarea>
                        </div>
                    </div>

                    <!-- Waypoints -->
                    <div class="edit-section">
                        <h3>üìç Balises</h3>
                        <div id="editWaypointsList">
                            ${renderWaypointsListReadOnly(course)}
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Fermer</button>
                    </div>
                `;
            } else {
                // Editable view for non-finished courses
                content.innerHTML = `
                    <form id="editCourseForm" onsubmit="saveCourseChanges(event)">
                        <!-- Basic Info -->
                        <div class="edit-section">
                            <h3>‚ÑπÔ∏è Informations G√©n√©rales</h3>
                            <div class="form-group">
                                <label>Nom du parcours:</label>
                                <input type="text" id="editCourseName" value="${course.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Description:</label>
                                <textarea id="editCourseDescription">${course.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="editSameStartFinish" ${course.sameStartFinish ? 'checked' : ''} onchange="toggleStartFinishMode()">
                                    <span>D√©part et arriv√©e au m√™me endroit</span>
                                </label>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    Si activ√©: un seul beacon sert de d√©part ET d'arriv√©e.<br>
                                    Si d√©sactiv√©: deux beacons distincts (d√©part vert, arriv√©e rouge).
                                </small>
                            </div>
                        </div>

                        <!-- Waypoints -->
                        <div class="edit-section">
                            <h3>üìç Balises</h3>
                            <div id="editWaypointsList">
                                ${renderWaypointsList(course)}
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addWaypoint()">‚ûï Ajouter une balise</button>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                            <button type="submit" class="btn btn-success">‚úÖ Enregistrer les modifications</button>
                        </div>
                    </form>
                `;
            }

            modal.style.display = 'block';
        }

        function renderWaypointsList(course) {
            if (!course.waypoints || course.waypoints.length === 0) {
                return '<p style="color: #666;">Aucune balise</p>';
            }

            return course.waypoints.map((wp, idx) => `
                <div class="waypoint-list-item" data-waypoint-index="${idx}">
                    <div>
                        <strong>Balise ${wp.id || idx + 1}:</strong> ${wp.name || 'Sans nom'}
                        <br>
                        <small style="color: #666;">${wp.lat != null ? `üìç ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}` : '‚ö†Ô∏è Pas de coordonn√©es'}</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-warning btn-small" onclick="editWaypoint(${idx})">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeWaypoint(${idx})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderWaypointsListReadOnly(course) {
            if (!course.waypoints || course.waypoints.length === 0) {
                return '<p style="color: #666;">Aucune balise</p>';
            }

            return course.waypoints.map((wp, idx) => `
                <div class="waypoint-list-item" style="background: #f5f5f5;">
                    <div>
                        <strong>Balise ${wp.id || idx + 1}:</strong> ${wp.name || 'Sans nom'}
                        <br>
                        <small style="color: #666;">${wp.lat != null ? `üìç ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}` : '‚ö†Ô∏è Pas de coordonn√©es'}</small>
                    </div>
                </div>
            `).join('');
        }

        function addWaypoint() {
            const course = window.currentEditingCourse;

            // Create new waypoint WITHOUT an ID (backend will assign one)
            let tempId = Date.now(); // Unique temporary ID

            const newWaypoint = {
                tempId: tempId, // Temporary ID for frontend tracking only
                name: `Nouvelle balise`,
                description: '',
                lat: null,
                lng: null,
                type: 'control'
            };

            if (!course.waypoints) {
                course.waypoints = [];
            }
            course.waypoints.push(newWaypoint);

            // Refresh the waypoints list
            document.getElementById('editWaypointsList').innerHTML = renderWaypointsList(course);

            alert('‚ö†Ô∏è IMPORTANT: Nouvelle balise ajout√©e!\n\n' +
                  'Cette balise a un nouveau QR code qui sera cr√©√©.\n' +
                  'Apr√®s avoir sauvegard√©, vous devez:\n' +
                  '1. Consulter les QR codes mis √† jour\n' +
                  '2. Imprimer le nouveau QR code\n' +
                  '3. Placer ce nouveau QR code sur le terrain\n\n' +
                  'Les autres QR codes restent inchang√©s!');
        }

        function editWaypoint(index) {
            alert(`Modifier balise ${index + 1}`);
        }

        function removeWaypoint(index) {
            if (confirm(`Supprimer la balise ${index + 1} ?`)) {
                window.currentEditingCourse.waypoints.splice(index, 1);
                document.getElementById('editWaypointsList').innerHTML = renderWaypointsList(window.currentEditingCourse);
            }
        }

        async function saveCourseChanges(event) {
            event.preventDefault();

            const course = window.currentEditingCourse;
            course.name = document.getElementById('editCourseName').value;
            course.description = document.getElementById('editCourseDescription').value;
            const sameStartFinish = document.getElementById('editSameStartFinish')?.checked || false;

            const updateData = {
                name: course.name,
                description: course.description,
                sameStartFinish: sameStartFinish,
                waypoints: (course.waypoints || []).map(wp => {
                    const waypoint = {
                        name: wp.name,
                        latitude: wp.latitude || wp.lat || 0,
                        longitude: wp.longitude || wp.lng || 0,
                        type: wp.type || 'control',
                        qr: wp.qr || ''
                    };

                    if (wp.id !== undefined && wp.id !== null) {
                        waypoint.id = wp.id;
                    }

                    return waypoint;
                })
            };

            try {
                const response = await AuthManager.fetch(`{{ path('api_parcours_update', {id: '__ID__'}) }}`.replace('__ID__', course.id), {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    const courseIndex = course.index !== undefined ? course.index : window.manageCourses.findIndex(c => c.id === course.id);
                    if (courseIndex !== -1) {
                        window.manageCourses[courseIndex].name = course.name;
                        window.manageCourses[courseIndex].description = course.description;
                    }

                    alert('‚úÖ Modifications enregistr√©es avec succ√®s !');
                    closeEditModal();
                    await loadCourses();
                } else {
                    throw new Error(result.error || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Error saving course:', error);
                alert('‚ùå Erreur lors de la sauvegarde : ' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('editCourseModal').style.display = 'none';
            window.currentEditingCourse = null;
        }

        function toggleStartFinishMode() {
            const checkbox = document.getElementById('editSameStartFinish');
            if (!checkbox) return;

            const course = window.currentEditingCourse;
            if (course) {
                course.sameStartFinish = checkbox.checked;
            }
        }

        async function viewQRCodes(index) {
            const course = window.manageCourses[index];
            const modal = document.getElementById('qrCodesModal');
            const isFinished = course.status === 'finished';
            
            if (isFinished) {
                // Read-only view for finished courses
                content.innerHTML = `
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                        <strong>‚ÑπÔ∏è Parcours termin√©</strong> - Ce parcours est termin√© et ne peut plus √™tre modifi√©.
                    </div>
                    
                    <!-- Basic Info -->
                    <div class="edit-section">
                        <h3>üìã Informations G√©n√©rales</h3>
                        <div class="form-group">
                            <label>Nom du parcours:</label>
                            <input type="text" value="${course.name || ''}" disabled style="background: #f5f5f5; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <textarea disabled style="background: #f5f5f5; cursor: not-allowed;">${course.description || ''}</textarea>
                        </div>
                    </div>

                    <!-- Waypoints -->
                    <div class="edit-section">
                        <h3>üéØ Balises</h3>
                        <div id="editWaypointsList">
                            ${renderWaypointsListReadOnly(course)}
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Fermer</button>
                    </div>
                `;
            } else {
                // Editable view for non-finished courses
                content.innerHTML = `
                    <form id="editCourseForm" onsubmit="saveCourseChanges(event)">
                        <!-- Basic Info -->
                        <div class="edit-section">
                            <h3>üìã Informations G√©n√©rales</h3>
                            <div class="form-group">
                                <label>Nom du parcours:</label>
                                <input type="text" id="editCourseName" value="${course.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Description:</label>
                                <textarea id="editCourseDescription">${course.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="editSameStartFinish" ${course.sameStartFinish ? 'checked' : ''} onchange="toggleStartFinishMode()">
                                    <span>D√©part et arriv√©e au m√™me endroit</span>
                                </label>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    Si activ√©: un seul beacon sert de d√©part ET d'arriv√©e.<br>
                                    Si d√©sactiv√©: deux beacons distincts (d√©part vert, arriv√©e rouge).
                                </small>
                            </div>
                        </div>

                        <!-- Waypoints -->
                        <div class="edit-section">
                            <h3>üéØ Balises</h3>
                            <div id="editWaypointsList">
                                ${renderWaypointsList(course)}
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addWaypoint()">‚ûï Ajouter une balise</button>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                            <button type="submit" class="btn btn-success">‚úÖ Enregistrer les modifications</button>
                        </div>
                    </form>
                `;
            }
            
            modal.style.display = 'block';
        }

        function renderWaypointsList(course) {
            if (!course.waypoints || course.waypoints.length === 0) {
                return '<p style="color: #666;">Aucune balise</p>';
            }
            
            return course.waypoints.map((wp, idx) => `
                <div class="waypoint-list-item" data-waypoint-index="${idx}">
                    <div>
                        <strong>Balise ${wp.id || idx + 1}:</strong> ${wp.name || 'Sans nom'}
                        <br>
                        <small style="color: #666;">${wp.lat != null ? `üìç ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}` : '‚ö†Ô∏è Pas de coordonn√©es'}</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-warning btn-small" onclick="editWaypoint(${idx})">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeWaypoint(${idx})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderWaypointsListReadOnly(course) {
            if (!course.waypoints || course.waypoints.length === 0) {
                return '<p style="color: #666;">Aucune balise</p>';
            }
            
            return course.waypoints.map((wp, idx) => `
                <div class="waypoint-list-item" style="background: #f5f5f5;">
                    <div>
                        <strong>Balise ${wp.id || idx + 1}:</strong> ${wp.name || 'Sans nom'}
                        <br>
                        <small style="color: #666;">${wp.lat != null ? `üìç ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}` : '‚ö†Ô∏è Pas de coordonn√©es'}</small>
                    </div>
                </div>
            `).join('');
        }



















        function addWaypoint() {
            const course = window.currentEditingCourse;
            
            // Create new waypoint WITHOUT an ID (backend will assign one)
            // Use a temporary negative ID for frontend display purposes only
            let tempId = Date.now(); // Unique temporary ID
            
            // Create new waypoint - NO ID property for new beacons
            const newWaypoint = {
                // NO id property - backend will create it
                tempId: tempId, // Temporary ID for frontend tracking only
                name: `Nouvelle balise`,
                description: '',
                lat: null,
                lng: null,
                type: 'control'
            };
            
            // Add to waypoints array
            if (!course.waypoints) {
                course.waypoints = [];
            }
            course.waypoints.push(newWaypoint);
            
            // Refresh the waypoints list
            document.getElementById('editWaypointsList').innerHTML = renderWaypointsList(course);
            
            // Show important warning
            alert('‚ö†Ô∏è IMPORTANT: Nouvelle balise ajout√©e!\n\n' +
                  'Cette balise a un nouveau QR code qui sera cr√©√©.\n' +
                  'Apr√®s avoir sauvegard√©, vous devez:\n' +
                  '1. Consulter les QR codes mis √† jour\n' +
                  '2. Imprimer le nouveau QR code\n' +
                  '3. Placer ce nouveau QR code sur le terrain\n\n' +
                  'Les autres QR codes restent inchang√©s!');
        }

        function editWaypoint(index) {
            alert(`Modifier balise ${index + 1}`);
        }

        function removeWaypoint(index) {
            if (confirm(`Supprimer la balise ${index + 1} ?`)) {
                window.currentEditingCourse.waypoints.splice(index, 1);
                document.getElementById('editWaypointsList').innerHTML = renderWaypointsList(window.currentEditingCourse);
            }
        }



        async function saveCourseChanges(event) {
            event.preventDefault();
            
            // Update course data from form
            const course = window.currentEditingCourse;
            course.name = document.getElementById('editCourseName').value;
            course.description = document.getElementById('editCourseDescription').value;
            const sameStartFinish = document.getElementById('editSameStartFinish')?.checked || false;
            
            // Prepare data for API
            const updateData = {
                name: course.name,
                description: course.description,
                sameStartFinish: sameStartFinish,
                waypoints: (course.waypoints || []).map(wp => {
                    const waypoint = {
                        name: wp.name,
                        latitude: wp.latitude || wp.lat || 0,
                        longitude: wp.longitude || wp.lng || 0,
                        type: wp.type || 'control',
                        qr: wp.qr || ''
                    };
                    
                    // Only include ID if waypoint has one (existing beacon)
                    // New beacons won't have an ID, so backend will create them
                    if (wp.id !== undefined && wp.id !== null) {
                        waypoint.id = wp.id;
                    }
                    
                    return waypoint;
                })
            };
            
            try {
                const response = await AuthManager.fetch(`{{ path('api_parcours_update', {id: '__ID__'}) }}`.replace('__ID__', course.id), {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Update the course in the local array
                    const courseIndex = course.index !== undefined ? course.index : window.manageCourses.findIndex(c => c.id === course.id);
                    if (courseIndex !== -1) {
                        window.manageCourses[courseIndex].name = course.name;
                        window.manageCourses[courseIndex].description = course.description;
                    }
                    
                    alert('‚úÖ Modifications enregistr√©es avec succ√®s !');
                    closeEditModal();
                    await loadCourses(); // Reload courses from database to ensure sync
                } else {
                    throw new Error(result.error || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Error saving course:', error);
                alert('‚ùå Erreur lors de la sauvegarde : ' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('editCourseModal').style.display = 'none';
            window.currentEditingCourse = null;
        }

        function toggleStartFinishMode() {
            const checkbox = document.getElementById('editSameStartFinish');
            if (!checkbox) return;
            
            const course = window.currentEditingCourse;
            if (course) {
                course.sameStartFinish = checkbox.checked;
            }
            
            // Could add visual feedback here if needed
            console.log('Start/Finish mode:', checkbox.checked ? 'Same location' : 'Different locations');
        }

        function viewOnMap(index) {
            const course = window.manageCourses[index];
            if (course && course.id) {
                // Redirect to map with courseId (no session selected by default)
                window.location.href = `/map?courseId=${course.id}`;
            } else {
                console.error('Course not found or missing ID');
            }
        }

        async function viewQRCodes(index) {
            const course = window.manageCourses[index];
            const modal = document.getElementById('qrCodesModal');
            const content = document.getElementById('qrCodesContent');
            
            // Check if course has been modified (compare waypoint count)
            const waypointCount = course.waypoints ? course.waypoints.length : 0;
            const previousWaypointCount = course.initialWaypointCount || waypointCount;
            
            if (waypointCount !== previousWaypointCount) {
                const diff = waypointCount - previousWaypointCount;
                const message = diff > 0 
                    ? `‚ö†Ô∏è ATTENTION: ${diff} balise(s) ont √©t√© ajout√©es depuis la cr√©ation.\n\nVous verrez de NOUVEAUX QR codes pour ces balises.\nLes QR codes existants restent inchang√©s.`
                    : `‚ö†Ô∏è ATTENTION: ${Math.abs(diff)} balise(s) ont √©t√© supprim√©es.\n\nCertains QR codes ne sont plus pr√©sents dans la liste.\nNe les r√©imprimez pas!`;
                
                alert(message);
            }
            
            content.innerHTML = '<p style="text-align: center;">G√©n√©ration des QR codes...</p>';
            modal.style.display = 'block';
            
            setTimeout(() => generateQRCodes(course), 100);
        }

        function generateQRCodes(course, retryCount = 0) {
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                if (retryCount > 50) {
                    document.getElementById('qrCodesContent').innerHTML = '<p style="color: #d32f2f; text-align: center;">Erreur: Impossible de charger la biblioth√®que QR Code. Veuillez recharger la page.</p>';
                    return;
                }
                console.log('QRCode library not loaded yet, retrying... (' + retryCount + ')');
                setTimeout(() => generateQRCodes(course, retryCount + 1), 300);
                return;
            }
            
            console.log('QRCode library loaded! Generating codes...');
            const content = document.getElementById('qrCodesContent');
            const qrCodes = [];

            // IMPORTANT: Use course creation timestamp (fixed) instead of current time
            // This ensures QR codes are STABLE and don't change when viewed multiple times
            const courseTimestamp = course.created_at || course.id;

            // Start Point - START QR Code
            const startQRData = {
                type: 'START_COURSE',
                courseId: course.id,
                courseName: course.name,
                pointName: course.startPoint?.name || 'Depart',
                courseCreated: courseTimestamp  // FIXED timestamp from course creation
            };
            qrCodes.push({
                label: `DEPART - DEBUT DU PARCOURS`,
                displayLabel: `Depart - DEBUT`,
                data: JSON.stringify(startQRData),
                color: '#000000'
            });

            // Waypoints QR Codes
            // IMPORTANT: QR codes are sorted by waypoint ID (not sequence) for stability
            // This means deleting/adding waypoints doesn't change existing QR codes
            if (course.waypoints) {
                // Sort by ID to ensure consistent order
                const sortedWaypoints = [...course.waypoints].sort((a, b) => a.id - b.id);
                
                sortedWaypoints.forEach((wp) => {
                    const wpQRData = {
                        type: 'WAYPOINT',
                        courseId: course.id,
                        courseName: course.name,
                        waypointId: wp.id,  // STABLE unique ID - never changes!
                        waypointName: wp.name,
                        courseCreated: courseTimestamp  // FIXED timestamp
                        // NOTE: No 'sequence' field! Order doesn't matter for QR codes.
                        // Students scan in any order they want during the course.
                    };
                    qrCodes.push({
                        label: wp.name,
                        displayLabel: wp.name,
                        data: JSON.stringify(wpQRData),
                        color: '#000000'
                    });
                });
            }

            // Start Point - END QR Code
            const endQRData = {
                type: 'END_COURSE',
                courseId: course.id,
                courseName: course.name,
                pointName: course.startPoint?.name || 'Arrivee',
                courseCreated: courseTimestamp  // FIXED timestamp
            };
            qrCodes.push({
                label: `ARRIVEE - FIN DU PARCOURS`,
                displayLabel: `Arrivee - FIN`,
                data: JSON.stringify(endQRData),
                color: '#000000'
            });

            // Generate QR codes
            content.innerHTML = qrCodes.map((qr, idx) => `
                <div class="qr-code-item">
                    <h4 style="color: #000000">${qr.displayLabel || qr.label}</h4>
                    <div id="qr-container-${idx}" style="display: flex; justify-content: center;"></div>
                </div>
            `).join('');

            // Render QR codes using QRCode constructor (qrcodejs library)
            qrCodes.forEach((qr, idx) => {
                const container = document.getElementById(`qr-container-${idx}`);
                new QRCode(container, {
                    text: qr.data,
                    width: 180,
                    height: 180,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            });

            window.currentCourseQRCodes = { course, qrCodes };
        }

        function downloadAllQRCodes() {
            if (!window.currentCourseQRCodes) return;
            
            // Check if jsPDF library is loaded
            if (typeof window.jspdf === 'undefined') {
                alert('Le g√©n√©rateur PDF se charge... Veuillez r√©essayer dans un instant.');
                return;
            }

            const { course, qrCodes } = window.currentCourseQRCodes;
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('portrait', 'mm', 'a4');

            qrCodes.forEach((qr, idx) => {
                // Add new page for each QR code (except first)
                if (idx > 0) {
                    pdf.addPage();
                }

                // QRCode library creates an img inside the container
                const container = document.getElementById(`qr-container-${idx}`);
                const img = container ? container.querySelector('img') : null;
                
                if (img) {
                    // Page title at top
                    pdf.setFontSize(24);
                    pdf.setTextColor(0, 0, 0);
                    const titleText = `Parcours: ${course.name}`;
                    const titleWidth = pdf.getTextWidth(titleText);
                    pdf.text(titleText, (210 - titleWidth) / 2, 20);
                    
                    // Large QR code centered on page (150x150mm)
                    const qrSize = 150;
                    const qrX = (210 - qrSize) / 2; // Center horizontally (A4 width = 210mm)
                    const qrY = 60; // Below the title
                    pdf.addImage(img.src, 'PNG', qrX, qrY, qrSize, qrSize);
                    
                    // QR code label at bottom (easy to cut off)
                    pdf.setFontSize(18);
                    pdf.setTextColor(0, 0, 0);
                    const labelWidth = pdf.getTextWidth(qr.label);
                    pdf.text(qr.label, (210 - labelWidth) / 2, 270);
                }
            });

            pdf.save(`QR_Codes_${course.name.replace(/[^a-z0-9]/gi, '_')}.pdf`);
        }

        function closeQRModal() {
            document.getElementById('qrCodesModal').style.display = 'none';
        }

        async function deleteCourse(index) {
            const course = window.manageCourses[index];
            if (!confirm(`Supprimer le parcours "${course.name}" ?\n\nCette action est irr√©versible et supprimera:\n- Le parcours\n- Toutes les balises\n- Toutes les limites\n\nContinuer ?`)) {
                return;
            }
            
            try {
                const response = await AuthManager.fetch(`{{ path('api_parcours_delete', {id: '__ID__'}) }}`.replace('__ID__', course.id), {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('‚úÖ Parcours supprim√© avec succ√®s !');
                    await loadCourses(); // Reload courses from database
                } else {
                    throw new Error(result.error || 'Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                alert('‚ùå Erreur lors de la suppression : ' + error.message);
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            const editModal = document.getElementById('editCourseModal');
            const qrModal = document.getElementById('qrCodesModal');
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === qrModal) {
                closeQRModal();
            }
        };
    </script>
    
    <!-- Load libraries from local assets (no CDN needed) -->
    <script src="{{ asset('assets/js/qrcode.min.js') }}" onload="window.qrCodeLibraryLoaded = true; console.log('QRCode library loaded from local assets');"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" data-turbo-track="reload" async onload="window.jspdfLibraryLoaded = true; console.log('jsPDF library loaded');"></script>
{% endblock %}

{% endblock %}
